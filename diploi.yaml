apiVersion: v1
kind: Application
name: tolgee

services:
  - name: postgres
    type: postgres
    version: "15"
    resources:
      memory: 512Mi
    persistence:
      size: 1Gi
    env:
      POSTGRES_DB: tolgee
      POSTGRES_USER: tolgee
      # Password will be auto-generated by Diploi

  - name: tolgee-backend
    type: service
    source:
      dockerfile: Dockerfile
    port: 8080
    resources:
      memory: 1Gi
      cpu: 500m
    env:
      - name: SPRING_PROFILES_ACTIVE
        value: prod
      - name: SPRING_DATASOURCE_URL
        value: jdbc:postgresql://postgres:5432/tolgee
      - name: SPRING_DATASOURCE_USERNAME
        value: tolgee
      - name: SPRING_DATASOURCE_PASSWORD
        valueFrom:
          secretKeyRef:
            name: postgres
            key: password
      - name: JAVA_OPTS
        value: "-Xmx450m -Xms450m -XX:MaxMetaspaceSize=120m -XX:+UseG1GC -XX:+UseStringDeduplication -XX:+UseCompressedOops"
      - name: SPRING_JPA_PROPERTIES_HIBERNATE_GENERATE_STATISTICS
        value: "false"
      - name: SPRING_JPA_PROPERTIES_HIBERNATE_JDBC_BATCH_SIZE
        value: "25"
      - name: SPRING_DATA_JPA_REPOSITORIES_BOOTSTRAP_MODE
        value: "deferred"
      - name: tolgee.postgres-autostart.enabled
        value: "false"
      - name: TOLGEE_JWT_SECRET
        valueFrom:
          secretKeyRef:
            name: tolgee-secrets
            key: jwt-secret
    healthCheck:
      path: /api/public/actuator/health
      port: 8080
    autoscaling:
      enabled: true
      minReplicas: 1
      maxReplicas: 3
      targetCPUUtilizationPercentage: 80

  - name: tolgee-frontend
    type: static
    source:
      context: webapp
      buildCommand: |
        npm ci
        npm run build
      outputDir: dist
    env:
      - name: VITE_APP_API_URL
        value: https://$(DIPLOI_SERVICE_TOLGEE_BACKEND_HOST)
    resources:
      memory: 256Mi
      cpu: 100m

ingress:
  - service: tolgee-frontend
    path: /
  - service: tolgee-backend
    path: /api/
    pathType: Prefix

secrets:
  - name: tolgee-secrets
    type: generated
    data:
      jwt-secret: 32